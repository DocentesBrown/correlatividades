<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Plan de Estudios – Visualizador y Planificador</title>
  <script src="https://unpkg.com/fuse.js@7.0.0"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    .status-green { background:#22c55e; color:#0a2e12; }
    .status-yellow { background:#eab308; color:#3a2f06; }
    .status-red { background:#ef4444; color:#3a0a0a; }
    .status-gray { background:#d1d5db; color:#1f2937; }
    .tile {
      border-radius: 14px;
      border: 1px solid #11182722;
      transition: transform .08s ease, box-shadow .12s ease, background .2s ease;
    }
    .tile:active { transform: scale(.98); }
    .tile:hover { box-shadow: 0 6px 18px rgba(0,0,0,.06); }
    .grid-auto {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: .75rem;
    }
    @media (min-width: 640px) {
      .grid-auto { gap: 1rem; }
    }
    dialog::backdrop { background: rgba(0,0,0,.35); }
    dialog {
      border: none; border-radius: 16px; padding:0;
      width: min(92vw, 460px);
      box-shadow: 0 30px 60px rgba(0,0,0,.25);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="px-4 py-3 bg-white shadow-sm sticky top-0 z-20">
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-3">
      <div>
        <h1 class="text-xl md:text-2xl font-bold leading-tight">Plan de Estudios</h1>
        <p class="text-xs md:text-sm text-gray-600">
          Buscá materias, marcá Cursada/Aprobada, cargá notas y visualizá el estado en la matriz.
        </p>
      </div>
      <div class="text-right">
        <div class="text-xs text-gray-500">Promedio general</div>
        <div id="promedioSpan" class="text-lg font-bold">—</div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto p-3 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
    <!-- Matriz (mapa) primero en móvil) -->
    <section class="lg:col-span-2 order-1">
      <div class="bg-white rounded-2xl shadow overflow-hidden">
        <div class="flex items-center justify-between px-3 md:px-4 py-2 md:py-3 border-b">
          <h2 class="font-semibold text-base md:text-lg">Matriz de correlatividades (sin flechas)</h2>
          <div class="hidden md:flex gap-2">
            <button id="fitBtn" class="text-sm border px-3 py-2 rounded-xl hover:bg-gray-50 min-h-[44px]">Ajustar</button>
            <button id="exportPNG" class="text-sm border px-3 py-2 rounded-xl hover:bg-gray-50 min-h-[44px]">PNG</button>
          </div>
        </div>
        <div class="p-3 md:p-4">
          <!-- Filtros de matriz -->
          <div class="flex flex-wrap gap-2 items-center mb-3">
            <span class="text-sm text-gray-600">Ordenar por:</span>
            <select id="matrixOrder" class="border rounded-lg px-2 py-1.5 text-sm">
              <option value="anio_codigo">Año → Código</option>
              <option value="nombre">Nombre</option>
              <option value="estado">Estado (Disponible/Habilitada/Bloqueada/Aprobada)</option>
            </select>
            <label class="flex items-center gap-2 text-sm ml-auto">
              <input type="checkbox" id="groupYear" class="h-4 w-4">
              Agrupar por año
            </label>
          </div>
          <div id="matrixContainer" class="grid-auto min-h-[50vh]"></div>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow p-4 md:p-5 mt-4 md:mt-6">
        <h3 class="font-semibold mb-2">Leyenda</h3>
        <ul class="text-sm text-gray-700 grid grid-cols-2 gap-x-6 gap-y-1">
          <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-2"></span>Habilitada</li>
          <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-yellow-500 mr-2"></span>Disponible</li>
          <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-2"></span>Bloqueada</li>
          <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-gray-300 mr-2"></span>Aprobada</li>
        </ul>
      </div>
    </section>

    <!-- Controles + Lista -->
    <section class="lg:col-span-1 order-2" id="listSection">
      <details class="bg-white rounded-2xl shadow open:md:open" open>
        <summary class="cursor-pointer list-none px-4 py-3 md:px-5 md:py-4 border-b flex items-center justify-between">
          <span class="font-semibold">Controles</span>
          <span class="text-xs text-gray-500 md:hidden">tocar para abrir/cerrar</span>
        </summary>
        <div class="p-4 md:p-5 space-y-3 md:space-y-4">
          <div>
            <label class="text-sm font-medium">Buscar materia</label>
            <input id="searchInput" class="mt-1 w-full border rounded-xl px-4 py-3 text-base outline-none focus:ring focus:ring-indigo-200" placeholder="Nombre o código..." inputmode="text" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-medium">Año</label>
              <select id="yearFilter" class="mt-1 w-full border rounded-xl px-3 py-3 text-base outline-none focus:ring focus:ring-indigo-200">
                <option value="">Todos</option>
              </select>
            </div>
            <div class="flex items-end">
              <button id="clearFilters" class="w-full border px-3 py-3 rounded-xl hover:bg-gray-50 text-sm md:text-base min-h-[44px]">Limpiar</button>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <input id="hideLocked" type="checkbox" class="h-5 w-5 rounded">
            <label for="hideLocked" class="text-sm select-none">Ocultar bloqueadas</label>
          </div>
          <div class="flex items-center gap-3">
            <input id="hideNoPrereq" type="checkbox" class="h-5 w-5 rounded">
            <label for="hideNoPrereq" class="text-sm select-none">Ocultar sin correlativas</label>
          </div>
          <div class="flex items-center gap-3">
            <input id="groupByYearList" type="checkbox" class="h-5 w-5 rounded">
            <label for="groupByYearList" class="text-sm select-none">Agrupar por año (lista)</label>
          </div>

          <p class="text-xs text-gray-500">Tip: tocá una tarjeta de la matriz o usá los checks de la lista. “Aprobada” pedirá nota y actualiza el promedio.</p>
        </div>
      </details>

      <div class="bg-white rounded-2xl shadow mt-4">
        <div class="px-4 py-3 border-b flex items-center justify-between">
          <h2 class="font-semibold">Materias</h2>
          <button id="scrollToMatrixBtn" class="text-xs border px-2 py-1.5 rounded-lg hover:bg-gray-50 md:hidden min-h-[36px]">Ir a la matriz</button>
        </div>
        <div id="courseList" class="space-y-2 max-h-[48vh] md:max-h-[65vh] overflow-auto p-3 pr-1"></div>
      </div>
    </section>
  </main>

  <!-- Barra fija inferior en móvil -->
  <div class="fixed bottom-0 inset-x-0 md:hidden z-30 px-3 pb-[max(0.5rem,env(safe-area-inset-bottom))]">
    <div class="bg-white border rounded-2xl shadow-lg flex items-center justify-between p-2">
      <button id="toTop" class="text-sm border px-3 py-2 rounded-xl min-h-[44px]">Arriba</button>
      <div class="flex gap-2">
        <button id="exportPNGMobile" class="text-sm border px-3 py-2 rounded-xl min-h-[44px]">PNG</button>
      </div>
    </div>
  </div>

  <!-- Modal de Nota -->
  <dialog id="notaDialog">
    <form method="dialog" class="p-5">
      <h3 class="text-lg font-semibold mb-1">Cargar nota</h3>
      <p id="notaMateria" class="text-sm text-gray-600 mb-3"></p>
      <div class="flex items-center gap-3 mb-4">
        <input id="notaInput" type="number" min="0" max="10" step="0.1" class="border rounded-lg px-3 py-2 w-32" placeholder="0 – 10" required />
        <button id="notaClear" type="button" class="text-sm underline text-gray-600">Quitar nota</button>
      </div>
      <div class="flex justify-end gap-2">
        <button value="cancel" class="border px-3 py-2 rounded-lg">Cancelar</button>
        <button id="notaSave" value="ok" class="bg-indigo-600 text-white px-3 py-2 rounded-lg">Guardar</button>
      </div>
    </form>
  </dialog>

  <footer class="max-w-7xl mx-auto px-4 py-6 text-xs text-gray-500">
    App libre y estática. Publicable en GitHub Pages/Netlify.
  </footer>

<script>
/* ------------------------- Carga de datos ------------------------- */
async function loadData() {
  const res = await fetch('data_plan_estudios.json');
  return await res.json();
}

/* ------------------------- Búsqueda ------------------------- */
function buildFuseIndex(cursos) {
  return new Fuse(cursos, {
    includeScore: true,
    keys: ['codigo', 'nombre'],
    threshold: 0.3,
    ignoreLocation: true,
  });
}

/* ------------------------- Estado ------------------------- */
/*
Reglas:
- REQUIERE ACREDITAR -> todas deben estar en Aprobadas.
- REQUIERE CURSADA   -> todas deben estar en Cursadas o Aprobadas.
*/
function computeStatus(curso, aprobadasSet, cursadasSet) {
  const reqAcred = curso.requiere_acreditar || curso.prerequisitos || [];
  const reqCurs  = curso.requiere_cursada || [];

  if (aprobadasSet.has(curso.codigo)) return 'aprobada';
  if (!reqAcred.length && !reqCurs.length) return 'disponible';

  const okAcred = reqAcred.every(p => aprobadasSet.has(p));
  const okCurs  = reqCurs.every(p => cursadasSet.has(p) || aprobadasSet.has(p));

  return (okAcred && okCurs) ? 'habilitada' : 'bloqueada';
}

function chipForStatus(status) {
  const map = {
    'aprobada': 'bg-gray-200 text-gray-700',
    'disponible': 'bg-yellow-100 text-yellow-700',
    'habilitada': 'bg-green-100 text-green-700',
    'bloqueada': 'bg-red-100 text-red-700',
  };
  return map[status] || 'bg-gray-100 text-gray-700';
}
function colorForStatus(status) {
  const map = {
    'aprobada': '#d1d5db',
    'disponible': '#eab308',
    'habilitada': '#22c55e',
    'bloqueada': '#ef4444',
  };
  return map[status] || '#9ca3af';
}
function listOrDash(arr) { return (!arr || !arr.length) ? '—' : arr.join(', '); }

/* ------------------------- Almacenamiento ------------------------- */
function loadSets() {
  return {
    aprobadasSet: new Set(JSON.parse(localStorage.getItem('aprobadas') || '[]')),
    cursadasSet:  new Set(JSON.parse(localStorage.getItem('cursadas')  || '[]')),
    notas:        JSON.parse(localStorage.getItem('notas')     || '{}'),
  };
}
function saveSets(aprobadasSet, cursadasSet, notas) {
  localStorage.setItem('aprobadas', JSON.stringify(Array.from(aprobadasSet)));
  localStorage.setItem('cursadas',  JSON.stringify(Array.from(cursadasSet)));
  localStorage.setItem('notas',     JSON.stringify(notas));
}

/* ------------------------- Promedio ------------------------- */
function computePromedio(notas) {
  const vals = Object.values(notas).map(v => Number(v)).filter(v => !Number.isNaN(v));
  if (!vals.length) return null;
  const m = vals.reduce((a,b) => a+b, 0) / vals.length;
  return Math.round(m * 100) / 100;
}
function renderPromedio(notas) {
  const span = document.getElementById('promedioSpan');
  const p = computePromedio(notas);
  span.textContent = (p == null) ? '—' : p.toFixed(2);
}

/* ------------------------- UI: Tarjetas de lista ------------------------- */
function makeCourseCard(curso, status, aprobadasSet, cursadasSet, notas) {
  const reqAcred = curso.requiere_acreditar || [];
  const reqCurs  = curso.requiere_cursada || [];
  const notaTxt  = (curso.codigo in notas) ? ` · Nota: ${notas[curso.codigo]}` : '';
  return `
  <div class="border rounded-xl p-3 active:opacity-80">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-sm md:text-base font-semibold break-words">${curso.codigo} — ${curso.nombre}</div>
        <div class="text-xs text-gray-600">Año: ${curso.anio ?? '—'} · Régimen: ${curso.regimen || '—'} · Formato: ${curso.formato || '—'}${notaTxt}</div>
        <div class="text-xs text-gray-600 mt-0.5">
          Acreditar: <span class="text-gray-800">${listOrDash(reqAcred)}</span>
          ${reqCurs.length ? ` · Cursada: <span class="text-gray-800">${listOrDash(reqCurs)}</span>` : ''}
        </div>
      </div>
      <span class="text-[11px] md:text-xs px-2 py-1 rounded-full ${chipForStatus(status)} whitespace-nowrap">${status}</span>
    </div>
    <div class="flex items-center flex-wrap gap-3 mt-2">
      <label class="text-sm flex items-center gap-2 select-none">
        <input type="checkbox" data-kind="cursada" data-codigo="${curso.codigo}" class="stateToggle h-5 w-5 rounded" ${cursadasSet.has(curso.codigo) ? 'checked' : ''}>
        Cursada
      </label>
      <label class="text-sm flex items-center gap-2 select-none">
        <input type="checkbox" data-kind="aprobada" data-codigo="${curso.codigo}" class="stateToggle h-5 w-5 rounded" ${aprobadasSet.has(curso.codigo) ? 'checked' : ''}>
        Aprobada
      </label>
      <button class="text-xs border px-2 py-1.5 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring active:opacity-80 min-h-[36px]" data-center="${curso.codigo}">Cargar/editar nota</button>
    </div>
  </div>`;
}

function renderCourseList(cursos, aprobadasSet, cursadasSet, notas, fuse, ui) {
  const query = ui.searchInput.value.trim();
  const year = ui.yearFilter.value;
  const hideLocked = ui.hideLocked.checked;
  const hideNoPrereq = ui.hideNoPrereq.checked;
  const groupByYear = ui.groupByYearList.checked;

  let filtered = cursos.slice();
  if (query) filtered = fuse.search(query).map(r => r.item);
  if (year) filtered = filtered.filter(c => String(c.anio || '') === year);

  const withStatus = filtered.map(c => {
    const st = computeStatus(c, aprobadasSet, cursadasSet);
    return { curso: c, status: st };
  }).filter(({curso, status}) => {
    if (hideLocked && status === 'bloqueada') return false;
    const sinPrevias = !( (curso.requiere_acreditar && curso.requiere_acreditar.length) ||
                          (curso.requiere_cursada && curso.requiere_cursada.length) );
    if (hideNoPrereq && sinPrevias) return false;
    return true;
  });

  let html = "";
  if (groupByYear) {
    const groups = {};
    for (const row of withStatus) {
      const y = row.curso.anio ?? '—';
      if (!groups[y]) groups[y] = [];
      groups[y].push(row);
    }
    const ys = Object.keys(groups).sort((a,b) => {
      if (a === '—') return 1;
      if (b === '—') return -1;
      return Number(a) - Number(b);
    });
    for (const y of ys) {
      html += `<div class="mt-3"><div class="text-[11px] uppercase tracking-wide text-gray-500 mb-1">Año ${y}</div>`;
      for (const {curso, status} of groups[y]) {
        html += makeCourseCard(curso, status, aprobadasSet, cursadasSet, notas);
      }
      html += `</div>`;
    }
  } else {
    for (const {curso, status} of withStatus) {
      html += makeCourseCard(curso, status, aprobadasSet, cursadasSet, notas);
    }
  }

  ui.courseList.innerHTML = html;
}

/* ------------------------- Matriz ------------------------- */
function tileClassByStatus(st) {
  if (st === 'aprobada') return 'status-gray';
  if (st === 'disponible') return 'status-yellow';
  if (st === 'habilitada') return 'status-green';
  if (st === 'bloqueada') return 'status-red';
  return '';
}
function renderMatrix(cursos, aprobadasSet, cursadasSet, notas, ui) {
  const order = ui.matrixOrder.value;
  const group = ui.groupYear.checked;

  let arr = cursos.slice();
  const byEstadoRank = c => {
    const st = computeStatus(c, aprobadasSet, cursadasSet);
    const rank = {disponible:0, habilitada:1, bloqueada:2, aprobada:3}[st] ?? 99;
    return [rank, c.anio ?? 99, c.codigo];
  };
  if (order === 'anio_codigo') arr.sort((a,b) => (a.anio??99)-(b.anio??99) || String(a.codigo).localeCompare(String(b.codigo)));
  if (order === 'nombre') arr.sort((a,b) => a.nombre.localeCompare(b.nombre));
  if (order === 'estado') arr.sort((a,b) => {
    const A = byEstadoRank(a), B = byEstadoRank(b);
    return (A[0]-B[0]) || (A[1]-B[1]) || String(A[2]).localeCompare(String(B[2]));
  });

  const container = document.getElementById('matrixContainer');
  container.innerHTML = '';

  const pushTile = (c) => {
    const st = computeStatus(c, aprobadasSet, cursadasSet);
    const notaTxt  = (c.codigo in notas) ? ` · Nota: ${notas[c.codigo]}` : '';
    const div = document.createElement('button');
    div.className = `tile p-3 text-left ${tileClassByStatus(st)}`;
    div.setAttribute('data-code', c.codigo);
    div.innerHTML = `
      <div class="text-xs opacity-90">#${c.codigo} · Año ${c.anio ?? '—'}</div>
      <div class="text-sm font-semibold leading-snug line-clamp-3">${c.nombre}</div>
      <div class="text-[11px] opacity-90 mt-1">Estado: ${st}${notaTxt}</div>
    `;
    // Click: toggle APROBADA con modal de nota
    div.addEventListener('click', () => {
      const code = c.codigo;
      const isAprob = aprobadasSet.has(code);
      if (isAprob) {
        // Si ya está aprobada, abrimos modal para editar/quitar nota
        openNotaModal(c, aprobadasSet, cursadasSet, notas, true);
      } else {
        // Aprobar + pedir nota
        openNotaModal(c, aprobadasSet, cursadasSet, notas, false, {aprobarAhora:true});
      }
    });
    container.appendChild(div);
  };

  if (group) {
    const groups = {};
    for (const c of arr) {
      const y = c.anio ?? '—';
      if (!groups[y]) groups[y] = [];
      groups[y].push(c);
    }
    const ys = Object.keys(groups).sort((a,b) => {
      if (a === '—') return 1;
      if (b === '—') return -1;
      return Number(a)-Number(b);
    });
    for (const y of ys) {
      const h = document.createElement('div');
      h.className = 'text-[11px] uppercase tracking-wide text-gray-500 mt-2';
      h.textContent = `Año ${y}`;
      container.appendChild(h);
      const grid = document.createElement('div');
      grid.className = 'grid-auto';
      groups[y].forEach(pushTile);
      container.appendChild(grid);
      // move tiles into grid
      const prevSiblings = [];
      while (container.lastChild && container.lastChild !== grid) {
        prevSiblings.push(container.lastChild);
        container.removeChild(container.lastChild);
      }
      prevSiblings.reverse().forEach(el => grid.appendChild(el));
    }
  } else {
    const grid = document.createElement('div');
    grid.className = 'grid-auto';
    container.appendChild(grid);
    arr.forEach(c => {
      const st = computeStatus(c, aprobadasSet, cursadasSet);
      const notaTxt  = (c.codigo in notas) ? ` · Nota: ${notas[c.codigo]}` : '';
      const btn = document.createElement('button');
      btn.className = `tile p-3 text-left ${tileClassByStatus(st)}`;
      btn.setAttribute('data-code', c.codigo);
      btn.innerHTML = `
        <div class="text-xs opacity-90">#${c.codigo} · Año ${c.anio ?? '—'}</div>
        <div class="text-sm font-semibold leading-snug line-clamp-3">${c.nombre}</div>
        <div class="text-[11px] opacity-90 mt-1">Estado: ${st}${notaTxt}</div>
      `;
      btn.addEventListener('click', () => {
        const code = c.codigo;
        if (aprobadasSet.has(code)) {
          openNotaModal(c, aprobadasSet, cursadasSet, notas, true);
        } else {
          openNotaModal(c, aprobadasSet, cursadasSet, notas, false, {aprobarAhora:true});
        }
      });
      grid.appendChild(btn);
    });
  }
}

/* ------------------------- Modal de Nota ------------------------- */
function openNotaModal(curso, aprobadasSet, cursadasSet, notas, editing, opts={}) {
  const dlg = document.getElementById('notaDialog');
  const txt = document.getElementById('notaMateria');
  const input = document.getElementById('notaInput');
  const clear = document.getElementById('notaClear');
  const save  = document.getElementById('notaSave');

  txt.textContent = `${curso.codigo} — ${curso.nombre}`;
  input.value = (curso.codigo in notas) ? notas[curso.codigo] : '';
  clear.onclick = () => { input.value = ''; };

  dlg.returnValue = '';
  dlg.showModal();

  save.onclick = (e) => {
    e.preventDefault();
    const v = input.value.trim();
    if (v !== '' && (Number(v) < 0 || Number(v) > 10)) return; // simple guard

    // Si viene con aprobarAhora, marcamos aprobada y desmarcamos cursada
    if (opts.aprobarAhora) {
      aprobadasSet.add(curso.codigo);
      cursadasSet.delete(curso.codigo);
    }

    if (v === '') { delete notas[curso.codigo]; }
    else { notas[curso.codigo] = String(Number(v)); }

    saveSets(aprobadasSet, cursadasSet, notas);
    renderAll(); // refrescar UI completa
    dlg.close('ok');
  };

  dlg.addEventListener('close', () => {
    // Si se canceló y venía con aprobarAhora (pero no guardó), igual mantener aprobada?
    // Preferimos no cambiar nada en cancel.
    if (dlg.returnValue !== 'ok' && opts.aprobarAhora) {
      // Revertir la aprobación tentativamente hecha? No la hicimos todavía: la hacemos recién en guardar.
      // Por lo tanto, nada que revertir.
    }
  }, { once: true });
}

/* ------------------------- Export PNG (matriz) ------------------------- */
async function exportMatrixPNG() {
  const el = document.getElementById('matrixContainer');
  // Uso html2canvas sin CDN declarada; para mantenerlo estático puro omitimos dependencia.
  // Alternativa: API de captura del navegador no disponible por seguridad; te doy una opción simple:
  alert('Para exportar la matriz como imagen sin dependencias, te conviene imprimir a PDF desde el navegador (Ctrl/Cmd+P) o agregar html2canvas desde CDN.');
}

/* ------------------------- App ------------------------- */
(async function init() {
  const data = await loadData();
  const cursos = data.cursos || [];
  const relaciones = data.relaciones || []; // ya no se usan para flechas; mantenemos por compat.

  // UI refs
  const ui = {
    searchInput: document.getElementById('searchInput'),
    yearFilter: document.getElementById('yearFilter'),
    hideLocked: document.getElementById('hideLocked'),
    hideNoPrereq: document.getElementById('hideNoPrereq'),
    groupByYearList: document.getElementById('groupByYearList'),
    courseList: document.getElementById('courseList'),
    scrollToMatrixBtn: document.getElementById('scrollToMatrixBtn'),
    toTop: document.getElementById('toTop'),

    // Matriz
    matrixOrder: document.getElementById('matrixOrder'),
    groupYear: document.getElementById('groupYear'),
  };

  // Poblar filtro año
  const years = Array.from(new Set(cursos.map(c => c.anio).filter(x => x != null))).sort((a,b)=>a-b);
  for (const y of years) {
    const opt = document.createElement('option');
    opt.value = String(y);
    opt.textContent = String(y);
    ui.yearFilter.appendChild(opt);
  }

  // Estado
  let { aprobadasSet, cursadasSet, notas } = loadSets();

  // Búsqueda
  const fuse = buildFuseIndex(cursos);

  // Render helpers
  function refreshList() {
    renderCourseList(cursos, aprobadasSet, cursadasSet, notas, fuse, ui);
  }
  function refreshMatrix() {
    renderMatrix(cursos, aprobadasSet, cursadasSet, notas, ui);
  }
  window.renderAll = function() {
    refreshList();
    refreshMatrix();
    renderPromedio(notas);
  }

  // Inicial
  window.renderAll();

  // Listeners: filtros lista
  ui.searchInput.addEventListener('input', refreshList);
  ui.yearFilter.addEventListener('change', refreshList);
  ui.hideLocked.addEventListener('change', refreshList);
  ui.hideNoPrereq.addEventListener('change', refreshList);
  ui.groupByYearList.addEventListener('change', refreshList);

  // Listeners: matriz
  ui.matrixOrder.addEventListener('change', refreshMatrix);
  ui.groupYear.addEventListener('change', refreshMatrix);

  // Navegación
  if (ui.scrollToMatrixBtn) ui.scrollToMatrixBtn.addEventListener('click', () => {
    document.getElementById('matrixContainer').scrollIntoView({ behavior:'smooth', block:'start' });
  });
  if (ui.toTop) ui.toTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

  // Delegación en LISTA: estado + abrir modal desde botón "Cargar/editar nota"
  ui.courseList.addEventListener('change', (e) => {
    if (!e.target.classList.contains('stateToggle')) return;
    const code = e.target.getAttribute('data-codigo');
    const kind = e.target.getAttribute('data-kind');
    const checked = e.target.checked;

    if (kind === 'aprobada') {
      if (checked) {
        // Abrir modal para nota (aprobar y pedir nota)
        const curso = cursos.find(x => x.codigo === code);
        openNotaModal(curso, aprobadasSet, cursadasSet, notas, false, {aprobarAhora:true});
      } else {
        aprobadasSet.delete(code);
        // si quitó aprobada no tocamos nota automáticamente (puede mantener registro), pero tiene sentido borrarla:
        delete notas[code];
        saveSets(aprobadasSet, cursadasSet, notas);
        renderAll();
      }
    } else if (kind === 'cursada') {
      if (checked) { if (!aprobadasSet.has(code)) cursadasSet.add(code); }
      else { cursadasSet.delete(code); }
      saveSets(aprobadasSet, cursadasSet, notas);
      renderAll();
    }
  });
  ui.courseList.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-center]');
    if (!btn) return;
    const code = btn.getAttribute('data-center');
    const curso = cursos.find(x => x.codigo === code);
    openNotaModal(curso, aprobadasSet, cursadasSet, notas, true);
  });

  // Export
  document.getElementById('exportPNG')?.addEventListener('click', exportMatrixPNG);
  document.getElementById('exportPNGMobile')?.addEventListener('click', exportMatrixPNG);
})();
</script>
</body>
</html>
