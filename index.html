<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Plan de Estudios – Visualizador y Planificador</title>
  <script src="https://unpkg.com/cytoscape@3.30.2/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/fuse.js@7.0.0"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Evita destellos al cambiar tamaños en móvil */
    html, body { height: 100%; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="px-4 py-3 bg-white shadow-sm sticky top-0 z-20">
    <div class="max-w-7xl mx-auto flex items-center justify-between gap-3">
      <div>
        <h1 class="text-xl md:text-2xl font-bold leading-tight">Plan de Estudios</h1>
        <p class="text-xs md:text-sm text-gray-600">Buscá materias, marcá Cursada/Aprobada y visualizá correlativas.</p>
      </div>
      <button id="scrollToListBtn" class="inline-flex items-center justify-center text-sm md:text-base border px-3 md:px-4 py-2 rounded-xl hover:bg-gray-50 active:opacity-80 min-h-[44px]">
        Materias
      </button>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto p-3 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6">
    <!-- Graph section first on mobile -->
    <section class="lg:col-span-2 order-1">
      <div class="bg-white rounded-2xl shadow overflow-hidden">
        <div class="flex items-center justify-between px-3 md:px-4 py-2 md:py-3 border-b">
          <h2 class="font-semibold text-base md:text-lg">Mapa de correlatividades</h2>
          <div class="hidden md:flex gap-2">
            <button id="fitBtn" class="text-sm border px-3 py-2 rounded-xl hover:bg-gray-50 min-h-[44px]">Ajustar</button>
            <button id="exportPngBtn" class="text-sm border px-3 py-2 rounded-xl hover:bg-gray-50 min-h-[44px]">PNG</button>
          </div>
        </div>
        <div id="cy" class="h-[68vh] sm:h-[70vh] lg:h-[72vh] min-h-[60vh]"></div>
      </div>

      <div class="bg-white rounded-2xl shadow p-4 md:p-5 mt-4 md:mt-6">
        <h3 class="font-semibold mb-2">Leyenda</h3>
        <ul class="text-sm text-gray-700 grid grid-cols-2 gap-x-6 gap-y-1">
          <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-green-500 mr-2"></span>Habilitada</li>
          <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-yellow-500 mr-2"></span>Disponible</li>
          <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-red-500 mr-2"></span>Bloqueada</li>
          <li class="flex items-center"><span class="inline-block w-3 h-3 rounded-full bg-gray-300 mr-2"></span>Aprobada</li>
        </ul>
      </div>
    </section>

    <!-- Controls + List -->
    <section class="lg:col-span-1 order-2" id="listSection">
      <details class="bg-white rounded-2xl shadow open:md:open" open>
        <summary class="cursor-pointer list-none px-4 py-3 md:px-5 md:py-4 border-b flex items-center justify-between">
          <span class="font-semibold">Controles</span>
          <span class="text-xs text-gray-500 md:hidden">tocar para abrir/cerrar</span>
        </summary>
        <div class="p-4 md:p-5 space-y-3 md:space-y-4">
          <div>
            <label class="text-sm font-medium">Buscar materia</label>
            <input id="searchInput" class="mt-1 w-full border rounded-xl px-4 py-3 text-base outline-none focus:ring focus:ring-indigo-200" placeholder="Nombre o código..." inputmode="text" />
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="text-sm font-medium">Año</label>
              <select id="yearFilter" class="mt-1 w-full border rounded-xl px-3 py-3 text-base outline-none focus:ring focus:ring-indigo-200">
                <option value="">Todos</option>
              </select>
            </div>
            <div class="flex items-end">
              <button id="clearFilters" class="w-full border px-3 py-3 rounded-xl hover:bg-gray-50 text-sm md:text-base min-h-[44px]">Limpiar</button>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <input id="hideLocked" type="checkbox" class="h-5 w-5 rounded">
            <label for="hideLocked" class="text-sm select-none">Ocultar bloqueadas</label>
          </div>
          <div class="flex items-center gap-3">
            <input id="hideNoPrereq" type="checkbox" class="h-5 w-5 rounded">
            <label for="hideNoPrereq" class="text-sm select-none">Ocultar sin correlativas</label>
          </div>
          <div class="flex items-center gap-3">
            <input id="groupByYear" type="checkbox" class="h-5 w-5 rounded">
            <label for="groupByYear" class="text-sm select-none">Agrupar por año</label>
          </div>

          <div class="flex gap-3 md:hidden pt-2">
            <button id="fitBtnMobile" class="flex-1 border px-3 py-3 rounded-xl hover:bg-gray-50 min-h-[44px]">Ajustar</button>
            <button id="exportPngBtnMobile" class="flex-1 border px-3 py-3 rounded-xl hover:bg-gray-50 min-h-[44px]">PNG</button>
          </div>

          <p class="text-xs text-gray-500">Tip: tocá nodos del grafo o los checks de “Cursada/Aprobada” para recalcular habilitadas. Se guarda en este dispositivo.</p>
        </div>
      </details>

      <div class="bg-white rounded-2xl shadow mt-4">
        <div class="px-4 py-3 border-b flex items-center justify-between">
          <h2 class="font-semibold">Materias</h2>
          <button id="scrollToGraphBtn" class="text-xs border px-2 py-1.5 rounded-lg hover:bg-gray-50 md:hidden min-h-[36px]">Ir al grafo</button>
        </div>
        <div id="courseList" class="space-y-2 max-h-[48vh] md:max-h-[65vh] overflow-auto p-3 pr-1"></div>
      </div>
    </section>
  </main>

  <!-- Sticky bottom action bar (móvil) -->
  <div class="fixed bottom-0 inset-x-0 md:hidden z-30 px-3 pb-[max(0.5rem,env(safe-area-inset-bottom))]">
    <div class="bg-white border rounded-2xl shadow-lg flex items-center justify-between p-2">
      <button id="toTop" class="text-sm border px-3 py-2 rounded-xl min-h-[44px]">Arriba</button>
      <div class="flex gap-2">
        <button id="fitBtnDock" class="text-sm border px-3 py-2 rounded-xl min-h-[44px]">Ajustar</button>
        <button id="exportPngBtnDock" class="text-sm border px-3 py-2 rounded-xl min-h-[44px]">PNG</button>
      </div>
    </div>
  </div>

  <footer class="max-w-7xl mx-auto px-4 py-6 text-xs text-gray-500">
    App libre y estática. Publicable en GitHub Pages/Netlify.
  </footer>

<script>
/* ------------------------- Datos ------------------------- */
async function loadData() {
  const res = await fetch('data_plan_estudios.json');
  return await res.json();
}

/* ------------------------- Búsqueda ------------------------- */
function buildFuseIndex(cursos) {
  return new Fuse(cursos, {
    includeScore: true,
    keys: ['codigo', 'nombre'],
    threshold: 0.3,
    ignoreLocation: true,
  });
}

/* ------------------------- Estado ------------------------- */
/*
Reglas:
- REQUIERE ACREDITAR -> todas deben estar en Aprobadas.
- REQUIERE CURSADA   -> todas deben estar en Cursadas o Aprobadas.
*/
function computeStatus(curso, aprobadasSet, cursadasSet) {
  const reqAcred = curso.requiere_acreditar || curso.prerequisitos || [];
  const reqCurs  = curso.requiere_cursada || [];

  if (aprobadasSet.has(curso.codigo)) return 'aprobada';
  if (!reqAcred.length && !reqCurs.length) return 'disponible';

  const okAcred = reqAcred.every(p => aprobadasSet.has(p));
  const okCurs  = reqCurs.every(p => cursadasSet.has(p) || aprobadasSet.has(p));

  return (okAcred && okCurs) ? 'habilitada' : 'bloqueada';
}

function chipForStatus(status) {
  const map = {
    'aprobada': 'bg-gray-200 text-gray-700',
    'disponible': 'bg-yellow-100 text-yellow-700',
    'habilitada': 'bg-green-100 text-green-700',
    'bloqueada': 'bg-red-100 text-red-700',
  };
  return map[status] || 'bg-gray-100 text-gray-700';
}

function colorForStatus(status) {
  const map = {
    'aprobada': '#d1d5db',   // gray-300
    'disponible': '#eab308', // yellow-500
    'habilitada': '#22c55e', // green-500
    'bloqueada': '#ef4444',  // red-500
  };
  return map[status] || '#9ca3af';
}

function listOrDash(arr) {
  if (!arr || !arr.length) return '—';
  return arr.join(', ');
}

/* ------------------------- UI Tarjeta ------------------------- */
function makeCourseCard(curso, status, aprobadasSet, cursadasSet) {
  const reqAcred = curso.requiere_acreditar || [];
  const reqCurs  = curso.requiere_cursada || [];
  return `
  <div class="border rounded-xl p-3 active:opacity-80">
    <div class="flex items-start justify-between gap-3">
      <div class="min-w-0">
        <div class="text-sm md:text-base font-semibold break-words">${curso.codigo} — ${curso.nombre}</div>
        <div class="text-xs text-gray-600">Año: ${curso.anio ?? '—'} · Régimen: ${curso.regimen || '—'} · Formato: ${curso.formato || '—'}</div>
        <div class="text-xs text-gray-600 mt-0.5">
          Acreditar: <span class="text-gray-800">${listOrDash(reqAcred)}</span>
          ${reqCurs && reqCurs.length ? ` · Cursada: <span class="text-gray-800">${listOrDash(reqCurs)}</span>` : ''}
        </div>
      </div>
      <span class="text-[11px] md:text-xs px-2 py-1 rounded-full ${chipForStatus(status)} whitespace-nowrap">${status}</span>
    </div>
    <div class="flex items-center flex-wrap gap-3 mt-2">
      <label class="text-sm flex items-center gap-2 select-none">
        <input type="checkbox" data-kind="cursada" data-codigo="${curso.codigo}" class="stateToggle h-5 w-5 rounded" ${cursadasSet.has(curso.codigo) ? 'checked' : ''}>
        Cursada
      </label>
      <label class="text-sm flex items-center gap-2 select-none">
        <input type="checkbox" data-kind="aprobada" data-codigo="${curso.codigo}" class="stateToggle h-5 w-5 rounded" ${aprobadasSet.has(curso.codigo) ? 'checked' : ''}>
        Aprobada
      </label>
      <button class="text-xs border px-2 py-1.5 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring active:opacity-80 min-h-[36px]" data-center="${curso.codigo}">Ver en gráfico</button>
    </div>
  </div>`;
}

/* ------------------------- Listado ------------------------- */
function renderCourseList(cursos, aprobadasSet, cursadasSet, fuse, ui) {
  const query = ui.searchInput.value.trim();
  const year = ui.yearFilter.value;
  const hideLocked = ui.hideLocked.checked;
  const hideNoPrereq = ui.hideNoPrereq.checked;
  const groupByYear = ui.groupByYear.checked;

  let filtered = cursos.slice();
  if (query) filtered = fuse.search(query).map(r => r.item);
  if (year) filtered = filtered.filter(c => String(c.anio || '') === year);

  const withStatus = filtered.map(c => {
    const st = computeStatus(c, aprobadasSet, cursadasSet);
    return { curso: c, status: st };
  }).filter(({curso, status}) => {
    if (hideLocked && status === 'bloqueada') return false;
    const sinPrevias = !( (curso.requiere_acreditar && curso.requiere_acreditar.length) ||
                          (curso.requiere_cursada && curso.requiere_cursada.length) );
    if (hideNoPrereq && sinPrevias) return false;
    return true;
  });

  let html = "";
  if (groupByYear) {
    const groups = {};
    for (const row of withStatus) {
      const y = row.curso.anio ?? '—';
      if (!groups[y]) groups[y] = [];
      groups[y].push(row);
    }
    const ys = Object.keys(groups).sort((a,b) => {
      if (a === '—') return 1;
      if (b === '—') return -1;
      return Number(a) - Number(b);
    });
    for (const y of ys) {
      html += `<div class="mt-3"><div class="text-[11px] uppercase tracking-wide text-gray-500 mb-1">Año ${y}</div>`;
      for (const {curso, status} of groups[y]) {
        html += makeCourseCard(curso, status, aprobadasSet, cursadasSet);
      }
      html += `</div>`;
    }
  } else {
    for (const {curso, status} of withStatus) {
      html += makeCourseCard(curso, status, aprobadasSet, cursadasSet);
    }
  }

  ui.courseList.innerHTML = html;
}

/* ------------------------- Grafo ------------------------- */
function buildGraph(cursos, relaciones, aprobadasSet, cursadasSet) {
  const cy = cytoscape({
    container: document.getElementById('cy'),
    elements: [
      ...cursos.map(c => ({ data: { id: c.codigo, label: `${c.codigo}\n${c.nombre}` } })),
      ...relaciones.map(e => ({ data: { id: e.from + '->' + e.to, source: e.from, target: e.to } })),
    ],
    style: [
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'text-wrap': 'wrap',
          'text-max-width': 160,
          'text-valign': 'center',
          'font-size': 10,
          'background-color': ele => {
            const code = ele.data('id');
            // Buscar curso y estado
            const curso = window.__cursos__.find(x => x.codigo === code);
            const status = computeStatus(curso, aprobadasSet, cursadasSet);
            return colorForStatus(status);
          },
          'border-width': 1,
          'border-color': '#111827',
          'width': 36,
          'height': 36,
          'shape': 'round-rectangle',
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 1.5,
          'curve-style': 'bezier',
          'target-arrow-shape': 'triangle',
          'line-color': '#9ca3af',
          'target-arrow-color': '#9ca3af',
        }
      },
      {
        selector: ':selected',
        style: {
          'border-width': 3,
          'border-color': '#4f46e5',
        }
      }
    ],
    layout: { name: 'breadthfirst', directed: true, spacingFactor: 1.1, fit: true, avoidOverlap: true }
  });
  return cy;
}

/* ------------------------- App ------------------------- */
(async function init() {
  const data = await loadData();
  const cursos = data.cursos || [];
  const relaciones = data.relaciones || [];
  window.__cursos__ = cursos;

  // UI refs
  const ui = {
    searchInput: document.getElementById('searchInput'),
    yearFilter: document.getElementById('yearFilter'),
    hideLocked: document.getElementById('hideLocked'),
    hideNoPrereq: document.getElementById('hideNoPrereq'),
    groupByYear: document.getElementById('groupByYear'),
    courseList: document.getElementById('courseList'),
    fitBtn: document.getElementById('fitBtn'),
    exportPngBtn: document.getElementById('exportPngBtn'),
    fitBtnMobile: document.getElementById('fitBtnMobile'),
    exportPngBtnMobile: document.getElementById('exportPngBtnMobile'),
    fitBtnDock: document.getElementById('fitBtnDock'),
    exportPngBtnDock: document.getElementById('exportPngBtnDock'),
    scrollToListBtn: document.getElementById('scrollToListBtn'),
    scrollToGraphBtn: document.getElementById('scrollToGraphBtn'),
    toTop: document.getElementById('toTop'),
    listSection: document.getElementById('listSection'),
  };

  // Populate year filter
  const years = Array.from(new Set(cursos.map(c => c.anio).filter(x => x != null))).sort((a,b)=>a-b);
  for (const y of years) {
    const opt = document.createElement('option');
    opt.value = String(y);
    opt.textContent = String(y);
    ui.yearFilter.appendChild(opt);
  }

  // Load saved state
  const aprobadasSet = new Set(JSON.parse(localStorage.getItem('aprobadas') || '[]'));
  const cursadasSet  = new Set(JSON.parse(localStorage.getItem('cursadas')  || '[]'));

  // Build search index
  const fuse = buildFuseIndex(cursos);

  // Render graph
  let cy = buildGraph(cursos, relaciones, aprobadasSet, cursadasSet);

  function refresh() {
    renderCourseList(cursos, aprobadasSet, cursadasSet, fuse, ui);
    // Recolor nodes
    cy.nodes().forEach(n => {
      const code = n.id();
      const curso = cursos.find(x => x.codigo === code);
      const status = computeStatus(curso, aprobadasSet, cursadasSet);
      n.style('background-color', colorForStatus(status));
    });
  }

  // Initial render
  refresh();

  // Listeners: filtros
  ui.searchInput.addEventListener('input', () => renderCourseList(cursos, aprobadasSet, cursadasSet, fuse, ui));
  ui.yearFilter.addEventListener('change', () => renderCourseList(cursos, aprobadasSet, cursadasSet, fuse, ui));
  ui.hideLocked.addEventListener('change', () => renderCourseList(cursos, aprobadasSet, cursadasSet, fuse, ui));
  ui.hideNoPrereq.addEventListener('change', () => renderCourseList(cursos, aprobadasSet, cursadasSet, fuse, ui));
  ui.groupByYear.addEventListener('change', () => renderCourseList(cursos, aprobadasSet, cursadasSet, fuse, ui));

  // Delegate list interactions (Cursada/Aprobada + centrar en grafo)
  ui.courseList.addEventListener('change', (e) => {
    if (e.target.classList.contains('stateToggle')) {
      const code = e.target.getAttribute('data-codigo');
      const kind = e.target.getAttribute('data-kind'); // 'cursada' | 'aprobada'
      const checked = e.target.checked;

      if (kind === 'aprobada') {
        if (checked) { aprobadasSet.add(code); cursadasSet.delete(code); } // si aprobó, ya no hace falta "cursada"
        else { aprobadasSet.delete(code); }
      } else if (kind === 'cursada') {
        if (checked) { if (!aprobadasSet.has(code)) cursadasSet.add(code); } // no sobrescribas aprobada
        else { cursadasSet.delete(code); }
      }

      localStorage.setItem('aprobadas', JSON.stringify(Array.from(aprobadasSet)));
      localStorage.setItem('cursadas',  JSON.stringify(Array.from(cursadasSet)));
      refresh();
    }
  });

  ui.courseList.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-center]');
    if (!btn) return;
    const code = btn.getAttribute('data-center');
    const node = cy.getElementById(code);
    if (node) {
      cy.elements().unselect();
      node.select();
      cy.animate({ fit: { eles: node.closedNeighborhood(), padding: 60 }, duration: 350 });
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });

  // Graph buttons (desktop)
  if (ui.fitBtn) ui.fitBtn.addEventListener('click', () => cy.fit(null, 40));
  if (ui.exportPngBtn) ui.exportPngBtn.addEventListener('click', () => {
    const png = cy.png({ full: true, scale: 2, bg: '#ffffff' });
    const a = document.createElement('a');
    a.href = png;
    a.download = 'mapa_correlatividades.png';
    a.click();
  });

  // Graph buttons (mobile duplicates)
  [ui.fitBtnMobile, ui.fitBtnDock].filter(Boolean).forEach(btn => btn.addEventListener('click', () => cy.fit(null, 40)));
  [ui.exportPngBtnMobile, ui.exportPngBtnDock].filter(Boolean).forEach(btn => btn.addEventListener('click', () => {
    const png = cy.png({ full: true, scale: 2, bg: '#ffffff' });
    const a = document.createElement('a');
    a.href = png;
    a.download = 'mapa_correlatividades.png';
    a.click();
  }));

  // Navigation helpers
  if (ui.scrollToListBtn) ui.scrollToListBtn.addEventListener('click', () => {
    ui.listSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });
  if (ui.scrollToGraphBtn) ui.scrollToGraphBtn.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
  if (ui.toTop) ui.toTop.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));

  // Clear filters
  const clearBtn = document.getElementById('clearFilters');
  if (clearBtn) clearBtn.addEventListener('click', () => {
    ui.searchInput.value = "";
    ui.yearFilter.value = "";
    ui.hideLocked.checked = false;
    ui.hideNoPrereq.checked = false;
    ui.groupByYear.checked = false;
    renderCourseList(cursos, aprobadasSet, cursadasSet, fuse, ui);
  });

  // Click node toggles APROBADA (atajo)
  cy.on('tap', 'node', (evt) => {
    const id = evt.target.id();
    if (aprobadasSet.has(id)) { aprobadasSet.delete(id); }
    else { aprobadasSet.add(id); cursadasSet.delete(id); } // aprobar saca 'cursada'
    localStorage.setItem('aprobadas', JSON.stringify(Array.from(aprobadasSet)));
    localStorage.setItem('cursadas',  JSON.stringify(Array.from(cursadasSet)));
    refresh();
  });

  // Mantener grafo sano en cambios de tamaño
  window.addEventListener('resize', () => cy.resize());
})();
</script>
</body>
</html>
