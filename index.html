<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plan de Estudios – Visualizador y Planificador</title>
  <script src="https://unpkg.com/cytoscape@3.30.2/dist/cytoscape.min.js"></script>
  <script src="https://unpkg.com/fuse.js@7.0.0"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="p-4 md:p-6 bg-white shadow-sm sticky top-0 z-10">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-2xl md:text-3xl font-bold">Plan de Estudios – Visualizador y Planificador</h1>
      <p class="text-sm text-gray-600">Cargado desde <code>data_plan_estudios.json</code>. Buscá, filtrá por año, marcá materias aprobadas y descubrí cuáles podés cursar.</p>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Panel de controles -->
    <section class="lg:col-span-1">
      <div class="bg-white rounded-2xl shadow p-4 md:p-5 space-y-4">
        <div>
          <label class="text-sm font-medium">Buscar materia</label>
          <input id="searchInput" class="mt-1 w-full border rounded-lg px-3 py-2 outline-none focus:ring focus:ring-indigo-200" placeholder="Nombre o código..." />
        </div>
        <div>
          <label class="text-sm font-medium">Filtrar por año</label>
          <select id="yearFilter" class="mt-1 w-full border rounded-lg px-3 py-2 outline-none focus:ring focus:ring-indigo-200">
            <option value="">Todos</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <input id="hideLocked" type="checkbox" class="h-4 w-4">
          <label for="hideLocked" class="text-sm">Ocultar materias bloqueadas (con previas sin aprobar)</label>
        </div>
        <div class="flex items-center gap-2">
          <input id="hideNoPrereq" type="checkbox" class="h-4 w-4">
          <label for="hideNoPrereq" class="text-sm">Ocultar materias sin correlativas</label>
        </div>
        <div class="flex items-center gap-2">
          <input id="groupByYear" type="checkbox" class="h-4 w-4">
          <label for="groupByYear" class="text-sm">Agrupar por año</label>
        </div>
        <div class="text-xs text-gray-500">Sugerencia: marcá materias como <em>aprobadas</em> para ver cuáles quedan <strong>habilitadas</strong>.</div>
      </div>

      <div class="bg-white rounded-2xl shadow p-4 md:p-5 mt-6">
        <h2 class="font-semibold mb-2">Materias</h2>
        <div id="courseList" class="space-y-2 max-h-[65vh] overflow-auto pr-1"></div>
      </div>
    </section>

    <!-- Visualización -->
    <section class="lg:col-span-2">
      <div class="bg-white rounded-2xl shadow p-0 overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <h2 class="font-semibold">Mapa de correlatividades</h2>
          <div class="flex gap-2">
            <button id="fitBtn" class="text-sm border px-3 py-1.5 rounded-lg hover:bg-gray-50">Ajustar vista</button>
            <button id="exportPngBtn" class="text-sm border px-3 py-1.5 rounded-lg hover:bg-gray-50">Exportar PNG</button>
          </div>
        </div>
        <div id="cy" class="h-[70vh]"></div>
      </div>

      <div class="bg-white rounded-2xl shadow p-4 md:p-5 mt-6">
        <h3 class="font-semibold mb-2">Leyenda</h3>
        <ul class="text-sm text-gray-700 list-disc pl-5 space-y-1">
          <li><span class="inline-block w-3 h-3 rounded-full bg-green-500 align-middle mr-2"></span>Habilitada: todas las correlativas aprobadas.</li>
          <li><span class="inline-block w-3 h-3 rounded-full bg-yellow-500 align-middle mr-2"></span>Disponible: no tiene correlativas.</li>
          <li><span class="inline-block w-3 h-3 rounded-full bg-red-500 align-middle mr-2"></span>Bloqueada: faltan aprobaciones.</li>
          <li><span class="inline-block w-3 h-3 rounded-full bg-gray-300 align-middle mr-2"></span>Aprobada: ya marcada por vos.</li>
        </ul>
      </div>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto p-6 text-xs text-gray-500">
    App libre y estática. Podés alojarla en GitHub Pages o Netlify.
  </footer>

<script>
async function loadData() {
  const res = await fetch('data_plan_estudios.json');
  return await res.json();
}

function buildFuseIndex(cursos) {
  return new Fuse(cursos, {
    includeScore: true,
    keys: ['codigo', 'nombre'],
    threshold: 0.3,
    ignoreLocation: true,
  });
}

function computeStatus(curso, aprobadasSet, prereqIndex) {
  const prereqs = curso.prerequisitos || [];
  if (aprobadasSet.has(curso.codigo)) return 'aprobada';
  if (!prereqs.length) return 'disponible';
  const ok = prereqs.every(p => aprobadasSet.has(p));
  return ok ? 'habilitada' : 'bloqueada';
}

function chipForStatus(status) {
  const map = {
    'aprobada': 'bg-gray-200 text-gray-700',
    'disponible': 'bg-yellow-100 text-yellow-700',
    'habilitada': 'bg-green-100 text-green-700',
    'bloqueada': 'bg-red-100 text-red-700',
  };
  return map[status] || 'bg-gray-100 text-gray-700';
}

function colorForStatus(status) {
  const map = {
    'aprobada': '#d1d5db',   // gray-300
    'disponible': '#eab308',  // yellow-500
    'habilitada': '#22c55e',  // green-500
    'bloqueada': '#ef4444',   // red-500
  };
  return map[status] || '#9ca3af';
}

function makeCourseCard(curso, status, aprobadasSet) {
  const prereq = (curso.prerequisitos || []).length ? curso.prerequisitos.join(', ') : '—';
  return `
  <div class="border rounded-xl p-3 hover:bg-gray-50">
    <div class="flex items-start justify-between gap-3">
      <div>
        <div class="text-sm font-semibold">${curso.codigo} — ${curso.nombre}</div>
        <div class="text-xs text-gray-600">Año: ${curso.anio ?? '—'} | Correlativas: ${prereq}</div>
      </div>
      <span class="text-xs px-2 py-1 rounded-full ${chipForStatus(status)}">${status}</span>
    </div>
    <div class="flex items-center gap-2 mt-2">
      <label class="text-sm flex items-center gap-2 select-none">
        <input type="checkbox" data-codigo="${curso.codigo}" class="aprobadoToggle h-4 w-4" ${aprobadasSet.has(curso.codigo) ? 'checked' : ''}>
        Marcar como aprobada
      </label>
      <button class="text-xs border px-2 py-1 rounded hover:bg-gray-50 focus:outline-none focus:ring" data-center="${curso.codigo}">Ver en gráfico</button>
    </div>
  </div>`;
}

function renderCourseList(cursos, aprobadasSet, fuse, ui) {
  const query = ui.searchInput.value.trim();
  const year = ui.yearFilter.value;
  const hideLocked = ui.hideLocked.checked;
  const hideNoPrereq = ui.hideNoPrereq.checked;
  const groupByYear = ui.groupByYear.checked;

  let filtered = cursos.slice();
  if (query) {
    filtered = fuse.search(query).map(r => r.item);
  }
  if (year) {
    filtered = filtered.filter(c => String(c.anio || '') === year);
  }

  const withStatus = filtered.map(c => {
    const st = computeStatus(c, aprobadasSet);
    return { curso: c, status: st };
  }).filter(({curso, status}) => {
    if (hideLocked && status === 'bloqueada') return false;
    if (hideNoPrereq && (!curso.prerequisitos || !curso.prerequisitos.length)) return false;
    return true;
  });

  // Grouping
  let html = "";
  if (groupByYear) {
    const groups = {};
    for (const row of withStatus) {
      const y = row.curso.anio ?? '—';
      if (!groups[y]) groups[y] = [];
      groups[y].push(row);
    }
    const ys = Object.keys(groups).sort((a,b) => {
      if (a === '—') return 1;
      if (b === '—') return -1;
      return Number(a) - Number(b);
    });
    for (const y of ys) {
      html += `<div class="mt-3"><div class="text-xs uppercase tracking-wide text-gray-500 mb-1">Año ${y}</div>`;
      for (const {curso, status} of groups[y]) {
        html += makeCourseCard(curso, status, aprobadasSet);
      }
      html += `</div>`;
    }
  } else {
    for (const {curso, status} of withStatus) {
      html += makeCourseCard(curso, status, aprobadasSet);
    }
  }

  ui.courseList.innerHTML = html;
}

function buildGraph(cursos, relaciones, aprobadasSet) {
  const cy = cytoscape({
    container: document.getElementById('cy'),
    elements: [
      ...cursos.map(c => ({ data: { id: c.codigo, label: `${c.codigo}\\n${c.nombre}` } })),
      ...relaciones.map(e => ({ data: { id: e.from + '->' + e.to, source: e.from, target: e.to } })),
    ],
    style: [
      {
        selector: 'node',
        style: {
          'label': 'data(label)',
          'text-wrap': 'wrap',
          'text-max-width': 160,
          'text-valign': 'center',
          'font-size': 10,
          'background-color': ele => {
            // status by prerequisites
            const code = ele.data('id');
            const curso = cursos.find(x => x.codigo === code);
            const status = computeStatus(curso, aprobadasSet);
            return colorForStatus(status);
          },
          'border-width': 1,
          'border-color': '#111827',
          'width': 36,
          'height': 36,
          'shape': 'round-rectangle',
        }
      },
      {
        selector: 'edge',
        style: {
          'width': 1.5,
          'curve-style': 'bezier',
          'target-arrow-shape': 'triangle',
          'line-color': '#9ca3af',
          'target-arrow-color': '#9ca3af',
        }
      },
      {
        selector: ':selected',
        style: {
          'border-width': 3,
          'border-color': '#4f46e5',
        }
      }
    ],
    layout: { name: 'breadthfirst', directed: true, spacingFactor: 1.1, fit: true, avoidOverlap: true }
  });
  return cy;
}

(async function init() {
  const data = await loadData();
  const cursos = data.cursos || [];
  const relaciones = data.relaciones || [];

  // UI refs
  const ui = {
    searchInput: document.getElementById('searchInput'),
    yearFilter: document.getElementById('yearFilter'),
    hideLocked: document.getElementById('hideLocked'),
    hideNoPrereq: document.getElementById('hideNoPrereq'),
    groupByYear: document.getElementById('groupByYear'),
    courseList: document.getElementById('courseList'),
    fitBtn: document.getElementById('fitBtn'),
    exportPngBtn: document.getElementById('exportPngBtn'),
  };

  // Populate year filter
  const years = Array.from(new Set(cursos.map(c => c.anio).filter(x => x != null))).sort((a,b)=>a-b);
  for (const y of years) {
    const opt = document.createElement('option');
    opt.value = String(y);
    opt.textContent = String(y);
    ui.yearFilter.appendChild(opt);
  }

  // Load saved state
  const saved = JSON.parse(localStorage.getItem('aprobadas') || '[]');
  const aprobadasSet = new Set(saved);

  // Build search index
  const fuse = buildFuseIndex(cursos);

  // Render graph
  let cy = buildGraph(cursos, relaciones, aprobadasSet);

  function refresh() {
    renderCourseList(cursos, aprobadasSet, fuse, ui);
    // Recolor nodes
    cy.nodes().forEach(n => {
      const code = n.id();
      const curso = cursos.find(x => x.codigo === code);
      const status = computeStatus(curso, aprobadasSet);
      n.style('background-color', colorForStatus(status));
    });
  }

  // Initial render
  refresh();

  // Listeners
  ui.searchInput.addEventListener('input', () => renderCourseList(cursos, aprobadasSet, fuse, ui));
  ui.yearFilter.addEventListener('change', () => renderCourseList(cursos, aprobadasSet, fuse, ui));
  ui.hideLocked.addEventListener('change', () => renderCourseList(cursos, aprobadasSet, fuse, ui));
  ui.hideNoPrereq.addEventListener('change', () => renderCourseList(cursos, aprobadasSet, fuse, ui));
  ui.groupByYear.addEventListener('change', () => renderCourseList(cursos, aprobadasSet, fuse, ui));

  // Delegate clicks in course list
  ui.courseList.addEventListener('change', (e) => {
    if (e.target.classList.contains('aprobadoToggle')) {
      const code = e.target.getAttribute('data-codigo');
      if (e.target.checked) aprobadasSet.add(code); else aprobadasSet.delete(code);
      localStorage.setItem('aprobadas', JSON.stringify(Array.from(aprobadasSet)));
      refresh();
    }
  });

  ui.courseList.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-center]');
    if (!btn) return;
    const code = btn.getAttribute('data-center');
    const node = cy.getElementById(code);
    if (node) {
      cy.elements().unselect();
      node.select();
      cy.animate({ fit: { eles: node.closedNeighborhood(), padding: 60 }, duration: 400 });
    }
  });

  // Graph buttons
  document.getElementById('fitBtn').addEventListener('click', () => cy.fit(null, 40));
  document.getElementById('exportPngBtn').addEventListener('click', () => {
    const png = cy.png({ full: true, scale: 2, bg: '#ffffff' });
    const a = document.createElement('a');
    a.href = png;
    a.download = 'mapa_correlatividades.png';
    a.click();
  });

  // Click node toggles approval
  cy.on('tap', 'node', (evt) => {
    const id = evt.target.id();
    if (aprobadasSet.has(id)) aprobadasSet.delete(id); else aprobadasSet.add(id);
    localStorage.setItem('aprobadas', JSON.stringify(Array.from(aprobadasSet)));
    refresh();
  });

  // Rebuild layout on window resize (optional)
  window.addEventListener('resize', () => cy.resize());
})();
</script>
</body>
</html>
